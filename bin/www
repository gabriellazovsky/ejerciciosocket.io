#!/usr/bin/env node

var { app, sessionMiddleware } = require('../app');
var debug = require('debug')('chat:server');
var http = require('http');
const { Server } = require("socket.io");

var port = normalizePort(process.env.PORT || '3000');
app.set('port', port);

var server = http.createServer(app);

// Socket.IO
const io = new Server(server);

// Usar sesión en Socket.IO
io.use((socket, next) => {
    sessionMiddleware(socket.request, {}, next);
});

// Usuarios conectados y historial
const users = {}; // username -> socket.id
let messages = []; // últimos 50 mensajes

io.on('connection', socket => {
    const username = socket.request.session.user;
    if(!username) return socket.disconnect(); // solo usuarios logueados
    socket.user = username;
    users[username] = socket.id;

    console.log('Usuario conectado:', socket.user);

    // Enviar historial
    socket.emit('history', messages);

    // Chat global
    socket.on('chat', msg => {
        const chatMsg = { user: socket.user, message: msg };
        messages.push(chatMsg);
        if(messages.length > 50) messages.shift();
        io.emit('chat', chatMsg);
    });

    // Chat privado
    socket.on('private', ({ to, message }) => {
        const targetId = users[to];
        if(targetId) {
            io.to(targetId).emit('private', { from: socket.user, message });
        }
    });

    socket.on('disconnect', () => {
        console.log('Usuario desconectado', socket.user);
        delete users[socket.user];
    });
});

// Arrancar servidor
server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

function normalizePort(val) {
    var port = parseInt(val, 10);
    if (isNaN(port)) return val;
    if (port >= 0) return port;
    return false;
}

function onError(error) {
    if (error.syscall !== 'listen') throw error;
    var bind = typeof port === 'string' ? 'Pipe ' + port : 'Port ' + port;
    switch (error.code) {
        case 'EACCES': console.error(bind + ' requiere privilegios'); process.exit(1); break;
        case 'EADDRINUSE': console.error(bind + ' ya en uso'); process.exit(1); break;
        default: throw error;
    }
}

function onListening() {
    var addr = server.address();
    var bind = typeof addr === 'string' ? 'pipe ' + addr : 'port ' + addr.port;
    debug('Listening on ' + bind);
}
